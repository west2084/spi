@page "/"
@rendermode InteractiveServer
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject spi.Services.Observaciones.ObservacionesService ObservacionesService

<PageTitle>Inicio</PageTitle>

<div class="card shadow p-4"
     style="background-color:#f0f0f0;color:black;height:550px;border-radius:12px;">
    <h2 class="text-center mb-3">Bienvenido al Sistema SPI</h2>

    @if (!string.IsNullOrEmpty(userName))
    {
        <p class="text-center fs-5">
            Hola, <strong style="color:black;">@userName</strong> 👋
        </p>
    }
    else
    {
        <p class="text-center text-muted">No se pudo identificar al usuario.</p>
    }

    <div class="row mt-4">
        <div class="col-md-6">
            <RadzenChart Style="height:300px;background-color:#2c2c2c;color:white;border-radius:8px;padding:1rem;">
                <p class="text-center">Cantidad de observaciones por estatus</p>
                <RadzenColumnSeries Data="@observacionesUsuario"
                                    CategoryProperty="Estatus"
                                    ValueProperty="Cantidad"
                                    Title="Observaciones por estatus" />
                <RadzenCategoryAxis />
                <RadzenValueAxis />
            </RadzenChart>
        </div>

        <div class="col-md-6">
            <RadzenChart Style="height:300px;background-color:#2c2c2c;color:white;border-radius:8px;padding:1rem;">
                <p class="text-center">Distribución de observaciones por área</p>
                <RadzenPieSeries Data="@observacionesPorArea"
                                 CategoryProperty="Area"
                                 ValueProperty="Cantidad"
                                 Title="Observaciones por área" />
                <RadzenLegend Position="LegendPosition.Right" />
            </RadzenChart>
        </div>
    </div>
</div>

@code {
    private string? userName;
    private List<ObsEstatus> observacionesUsuario = new();
    private List<ObsArea> observacionesPorArea = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
        }

        await CargarObservacionesGlobal(user);
    }

    private async Task CargarObservacionesGlobal(System.Security.Claims.ClaimsPrincipal? user)
    {
        // Usar servicio que respeta rol/AreaId
        var filtradas = await ObservacionesService.GetObservacionesAsync(user);

        observacionesUsuario = filtradas
            .GroupBy(o => o.estatus)
            .Select(g => new ObsEstatus
            {
                Estatus = g.Key,
                Cantidad = g.Count()
            })
            .ToList();

        // Obtener agrupado por áreas desde el servicio que respeta rol/AreaId
        var grupos = await ObservacionesService.GetGroupObsAsync(user);
        observacionesPorArea = grupos
            .Select(g => new ObsArea { Area = g.Area, Cantidad = g.cantidad })
            .ToList();
    }

    public class ObsEstatus
    {
        public string Estatus { get; set; }
        public int Cantidad { get; set; }
    }

    public class ObsArea
    {
        public string Area { get; set; }
        public int Cantidad { get; set; }
    }

}
