@rendermode InteractiveServer
@page "/observaciones/pendientes"
@inject spi.Services.Observaciones.ObservacionesService ObservacionesService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS
@attribute [Authorize]

<div class="card shadow p-4"
     style="background-color:#f0f0f0f0;color:black;border-radius:12px;">

    <h2 class="text-center mb-3">Observaciones Pendientes</h2>
    <p class="text-center">Administra y da seguimiento a las observaciones en estado pendiente</p>

    <div style="background-color:#2c2c2c;border-radius:8px;padding:1rem;">
        <RadzenDataGrid @ref="grid" TItem="Observaciones" Data="@observacionesPendientes"
                        AllowPaging="true" PageSize="10"
                        AllowSorting="true" AllowFiltering="true"
                        AllowColumnResize="true"
                        Style="height:500px;color:#e0e0e0;">
            <Columns>
                <RadzenDataGridColumn TItem="Observaciones" Property="Proyecto.des_proy" Title="Proyecto" />
                <RadzenDataGridColumn TItem="Observaciones" Property="indicador" Title="Indicador" />
                <RadzenDataGridColumn TItem="Observaciones" Property="des_obs" Title="Descripción" />
                <RadzenDataGridColumn TItem="Observaciones" Property="fecha_obs" Title="Fecha Observación"
                                      FormatString="{0:dd/MM/yyyy}" />

                <RadzenDataGridColumn TItem="Observaciones" Property="estatus" Title="Estatus" Width="120px">
                    <Template Context="obs">
                        <RadzenBadge Text="@obs.estatus" Style="margin:2px;font-weight:bold;"
                                     Color="@(obs.estatus == "Pendiente" ? "Warning" :
                                                                                                                                                                                                              obs.estatus == "Terminado" ? "Success" : "Danger")" />
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="Observaciones" Context="obs" Title="Acciones" Width="450px">
                    <Template Context="obs">
                        <RadzenButton Text="Evidencias" Icon="visibility"
                                      Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary"
                                      Style="margin-right:5px;border-radius:4px;"
                                      Click="@(() => VerEvidencias(obs.Id, obs.ProyectoId))" />

                        <RadzenButton Text="Editar" Icon="edit"
                                      Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary"
                                      Style="margin-right:5px;border-radius:4px;"
                                      Click="@(() => EditarObservacion(obs.Id))" />

                        <RadzenButton Text="Terminar" Icon="check_circle"
                                      Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success"
                                      Style="margin-right:5px;border-radius:4px;"
                                      Click="@(() => CambiarEstatus(obs.Id, "Terminado"))" />

                        <RadzenButton Text="Cancelar" Icon="cancel"
                                      Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger"
                                      Style="border-radius:4px;"
                                      Click="@(() => CambiarEstatus(obs.Id, "Cancelado"))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
</div>

@code {
    private RadzenDataGrid<Observaciones> grid;
    private List<Observaciones> observacionesPendientes;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Pedimos al servicio las pendientes filtradas por usuario/rol
        observacionesPendientes = await ObservacionesService.GetObservacionesPendientesAsync(user);
    }

    private void VerEvidencias(int idObs, int proyectoId)
    {
        Navigation.NavigateTo($"/evidencias/{idObs}/{proyectoId}");
    }

    private void EditarObservacion(int idObs)
    {
        Navigation.NavigateTo($"/editobservaciones/{idObs}");
    }

    private async Task CambiarEstatus(int idObs, string nuevoEstatus)
    {
        var obs = observacionesPendientes.FirstOrDefault(o => o.Id == idObs);
        if (obs != null)
        {
            obs.estatus = nuevoEstatus;
            await ObservacionesService.UpdateObservacionesAsync(obs);

            // refrescar lista
            observacionesPendientes = observacionesPendientes
                .Where(o => o.estatus == "Pendiente")
                .ToList();

            await grid.Reload();
            StateHasChanged();
        }
    }
}
