@rendermode InteractiveServer
@page "/observaciones/{ProyectoId:int?}"
@inject Services.Observaciones.ObservacionesService ObservacionesService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@using spi.Models
@attribute [Authorize]

<div class="card shadow p-4"
     style="background-color:#f0f0f0;color:black;border-radius:12px;">

    <h2 class="text-center mb-3">Observaciones</h2>
    <p class="text-center">Valida y administra las observaciones del proyecto</p>
    @Message

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-secondary" @onclick="Regresar"
                style="border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.3);">
            ⬅ Regresar
        </button>

        <RadzenButton Text="Agregar Observaciones"
                      Icon="add_circle"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="background-color:#00bcd4;border:none;font-weight:bold;
                                 border-radius:6px;box-shadow:0 4px 10px rgba(0,0,0,0.3);"
                      Click="@(() => createobservaciones())" />
    </div>

    <div class="d-flex mb-3">
        <InputText @bind-Value="searchTerm" placeholder="Buscar observaciones..." class="form-control me-2" />
        <button class="btn btn-info" @onclick="Buscar">🔍 Buscar</button>
    </div>


    @if (orderDetails == null)
    {
        <p><em>Cargando...</em></p>
    }
    else
    {
        <div style="background-color:#2c2c2c;border-radius:8px;padding:1rem;">
            <RadzenDataGrid @ref="grid" Data="@orderDetails"
                            AllowVirtualization="true"
                            AllowFiltering="true"
                            FilterPopupRenderMode="PopupRenderMode.OnDemand"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            LogicalFilterOperator="LogicalFilterOperator.Or"
                            AllowSorting="true"
                            TItem="Observaciones"
                            Style="height:400px;color:#e0e0e0;">
                <Columns>
                    <RadzenDataGridColumn Property="@nameof(Observaciones.indicador)" Title="Indicador" />
                    <RadzenDataGridColumn Property="@nameof(Observaciones.valor_meta)" Title="Meta" />
                    <RadzenDataGridColumn Property="@nameof(Observaciones.valor_cumplimiento)" Title="Porcentaje" />
                    <RadzenDataGridColumn Property="@nameof(Observaciones.estatus)" Title="Estatus" />
                    <RadzenDataGridColumn Property="@nameof(Observaciones.des_obs)" Title="Observaciones" />

                    <RadzenDataGridColumn Title="Áreas">
                        <Template Context="data">
                            @if (data.ObservacionAreas != null && data.ObservacionAreas.Any())
                            {
                                @string.Join(", ", data.ObservacionAreas.Select(oa => oa.Area.siglas_area))
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Title="Editar">
                        <Template Context="item">
                            <RadzenButton Icon="description"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Size="ButtonSize.Small"
                                          Style="border-radius:4px;"
                                          Click="@(() => IrAEditar(item.Id))" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Title="Evidencias">
                        <Template Context="item">
                            <RadzenButton Icon="visibility"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Size="ButtonSize.Small"
                                          Style="border-radius:4px;"
                                          Click="@(() => IrADetalle(item.Id))" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </div>
    }
</div>

@code {
    List<Observaciones> orderDetails;
    RadzenDataGrid<Observaciones> grid;

    [Parameter] public int ProyectoId { get; set; }

    public string Message { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Usar el método filtrado por usuario
            orderDetails = await ObservacionesService.GetProyObservacionesAsync(ProyectoId, user);
        }
        catch (Exception e)
        {
            Message = e.Message;
        }
    }

    private void createobservaciones()
    {
        Navigation.NavigateTo($"/createobservaciones/{ProyectoId}");
    }

    void IrADetalle(int id)
    {
        Navigation.NavigateTo($"/evidencias/{id}/{ProyectoId}");
    }

    void IrAEditar(int id)
    {
        Navigation.NavigateTo($"/editobservaciones/{id}");
    }

    void Regresar()
    {
        Navigation.NavigateTo($"/Proyecto");
    }

    private string searchTerm = string.Empty;

    private async Task Buscar()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        orderDetails = await ObservacionesService.SearchObservacionesAsync(ProyectoId, user, searchTerm);
    }

}

