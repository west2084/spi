@rendermode InteractiveServer
@page "/evidencias/{ObservacionId:int?}/{ProyectoId:int?}"
@inject Services.Evidencias.EvidenciasService EvidenciasService
@using spi;
@using System.IO;
@using spi.Services.Evidencias;
@using spi.Models;
@using spi.Components.Pages.Evidencias;
@inject IJSRuntime JS
@inject NavigationManager Navigation


@code {
    [Parameter]
    public int ObservacionId { get; set; }
    [Parameter]
    public int ProyectoId { get; set; }


}

@using System.Data;

<div class="card shadow p-4"
     style="background-color:#f0f0f0;color:black;border-radius:12px;">

    <h2 class="text-center mb-3">Gestión de Evidencias</h2>
    <p class="text-center">Valida y administra las evidencias asociadas a las observaciones</p>
    @Message

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-secondary" @onclick="Regresar"
                style="border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.3);">
            ⬅ Regresar
        </button>

        <RadzenButton Text="Agregar Evidencias"
                      Icon="add_circle"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="background-color:#00bcd4;border:none;font-weight:bold;
                                 border-radius:6px;box-shadow:0 4px 10px rgba(0,0,0,0.3);"
                      Click="@(() => createevidencias(ObservacionId))" />
    </div>

    @if (orderDetails == null)
    {
        <p><em>Cargando...</em></p>
    }
    else
    {
        <div style="background-color:#2c2c2c;border-radius:8px;padding:1rem;">
            <RadzenDataGrid @ref="grid" Data="@orderDetails"
                            AllowVirtualization="true"
                            AllowFiltering="true"
                            FilterPopupRenderMode="PopupRenderMode.OnDemand"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            LogicalFilterOperator="LogicalFilterOperator.Or"
                            AllowSorting="true"
                            TItem="Evidencias"
                            Style="height:400px;color:#e0e0e0;">
                <Columns>
                    <RadzenDataGridColumn Property="@nameof(Evidencias.NombreOriginal)" Title="Nombre Archivo" />

                    <RadzenDataGridColumn Title="Archivo">
                        <Template Context="data">
                            <a href="@("/spi" + data.RutaArchivo)" target="_blank" download="@data.NombreOriginal"
                               style="color:#4dd0e1;text-decoration:none;font-weight:bold;">
                                📂 Descargar
                            </a>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Property="@nameof(Evidencias.FechaSubida)" Title="Fecha Act" />

                    <RadzenDataGridColumn Title="Observación">
                        <Template Context="data">
                            @data.Observaciones?.cve_obs
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </div>
    }
</div>


@code {


    List<Evidencias> orderDetails;
    RadzenDataGrid<Evidencias> grid;



    public IEnumerable<Models.Observaciones> observaciones { get; set; }

    public string Message { get; set; }



    protected override async Task OnInitializedAsync()
    {

        try
        {

            orderDetails = await EvidenciasService.GetObsEvidenciasAsync(ObservacionId);

        }
        catch (Exception e)
        {
            Message = e.Message;
        }
    }


    private void createevidencias(int id)
    {
        // Lógica de abrir modal o lo que necesites

        Navigation.NavigateTo($"/createevidencias/{id}/{ProyectoId}");


    }


    void Regresar()
    {
        Navigation.NavigateTo($"/observaciones/{ProyectoId}"); // Aquí la ruta a donde quieras volver
    }




}

